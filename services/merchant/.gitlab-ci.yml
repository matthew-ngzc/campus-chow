# GitLab CI/CD Pipeline for Merchant Service
# https://gitlab.com/cs302-2025/g4-team2/services/merchant

stages:
  - build
  - test
  - package
  - push
  - deploy

variables:
  # Maven settings
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  
  # Docker settings
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  
  # Image naming
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest

# Cache Maven dependencies for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/
    - target/

# Build Stage - Compile the application
build:
  stage: build
  image: maven:3.9.6-eclipse-temurin-17-alpine
  script:
    - echo "Building Merchant Service..."
    - mvn $MAVEN_CLI_OPTS clean compile
  artifacts:
    paths:
      - target/
    expire_in: 1 hour
  only:
    - branches
    - merge_requests
    - tags

# Test Stage - Run unit and integration tests
test:
  stage: test
  image: maven:3.9.6-eclipse-temurin-17-alpine
  services:
    - name: docker:24-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    TESTCONTAINERS_HOST_OVERRIDE: docker
    TESTCONTAINERS_RYUK_DISABLED: "true"
  before_script:
    - echo "Preparing test environment..."
    - apk add --no-cache docker-cli
    - until docker info; do echo "Waiting for Docker..."; sleep 1; done
    - echo "Docker is ready!"
  script:
    - echo "Running tests..."
    - mvn $MAVEN_CLI_OPTS test
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  only:
    - branches
    - merge_requests
    - tags

# Package Stage - Build Docker image
package:
  stage: package
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - echo "Preparing Docker build..."
    - docker info
  script:
    - echo "Building Docker image..."
    - docker build -t $IMAGE_NAME:$IMAGE_TAG -t $IMAGE_NAME:latest .
    - echo "Docker image built successfully!"
    - docker images
  only:
    - branches
    - merge_requests
    - tags

# Push Stage - Push Docker image to GitLab Container Registry
push:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - echo "Logging into GitLab Container Registry..."
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "Rebuilding image for push..."
    - docker build -t $IMAGE_NAME:$IMAGE_TAG -t $IMAGE_NAME:latest .
    - echo "Pushing Docker image to registry..."
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker push $IMAGE_NAME:latest
    - echo "Image pushed successfully"
    - echo "Image available at $IMAGE_NAME:$IMAGE_TAG"
    - echo "Latest image at $IMAGE_NAME:latest"
  only:
    - main
    - master
    - develop
    - tags

# Deploy to AWS (single environment)
deploy:
  stage: deploy
  image: docker:24
  services:
    - docker:24-dind
  variables:
    AWS_DEFAULT_REGION: ap-southeast-2
    GIT_STRATEGY: clone
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  before_script:
    - apk add --no-cache python3 py3-pip curl bash
    - pip3 install awscli --break-system-packages
    - until docker info; do echo "Waiting for Docker..."; sleep 1; done
    - curl -Lo /tmp/copilot-binary https://github.com/aws/copilot-cli/releases/latest/download/copilot-linux
    - chmod +x /tmp/copilot-binary && mv /tmp/copilot-binary /usr/local/bin/copilot
    - copilot --version
  script:
    - copilot svc deploy --name merchant --env staging
  environment:
    name: staging
    url: http://smunch-Publi-zJmL6QzNfpw8-523599691.ap-southeast-2.elb.amazonaws.com
  only:
    - develop
    - master
    - main
  # Automatic deployment from both develop and main branches